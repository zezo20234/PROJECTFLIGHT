<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Flight Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="Flight Tracker" />
<link rel="apple-touch-icon" href="airlogo.jpg" />
<link rel="manifest" href="manifest.json" />

<style>
  :root {
    --bg: #f8fafc; --fg: #0f172a;
    --card: #ffffff; --muted: #6b7280;
    --primary: #7c3aed; --blue: #0ea5e9; --gray: #6b7280;
    --border: #e5e7eb; --shadow: 0 8px 30px rgba(0,0,0,.08);
  }
  * { box-sizing: border-box; }
  body {
    margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: var(--bg); color: var(--fg);
  }
  .btn { width: 100%; padding: 14px; border: 0; border-radius: 12px; color: #fff; font-weight: 700; cursor: pointer; }
  .btn-primary { background: var(--primary); }
  .btn-blue { background: var(--blue); }
  .btn-gray { background: var(--gray); }
  .btn-outline { background: #fff; color: var(--fg); border: 1px solid var(--border); }
  .row { display: flex; gap: 10px; flex-wrap: wrap; }
  .w-auto { width: auto; }
  .hidden { display: none !important; }
  .centered { min-height: 100vh; display: grid; place-items: center; padding: 16px; }
  .card { width: 100%; max-width: 430px; background: var(--card); border-radius: 16px; padding: 24px; box-shadow: var(--shadow); }
  h1, h2, h3 { margin: 0 0 10px; }
  .sub { color: var(--muted); margin-bottom: 18px; }
  label { font-size: 13px; color: #334155; }
  input, select {
    width: 100%; padding: 12px 14px; border-radius: 12px; border: 1px solid var(--border); margin-top: 6px;
    font-size: 16px; background: #fff; color: var(--fg);
  }
  input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(124,58,237,.12); }
  .error { color: #dc2626; min-height: 1.2em; margin-top: 8px; }
  header { position: sticky; top: 0; z-index: 50; background: #fff; border-bottom: 1px solid var(--border);
    display: flex; justify-content: space-between; align-items: center; padding: 12px 16px;
  }
  .header-stats { display: flex; gap: 10px; }
  .count-badge { background: #eef2ff; color: #3730a3; padding: 6px 12px; border-radius: 999px; font-weight: 800; font-size: 14px; }
  main { padding: 16px; display: grid; gap: 20px; }
  .card-section { background: #fff; border-radius: 16px; padding: 16px; box-shadow: var(--shadow); }
  .section-title { margin-bottom: 8px; }
  .list { display: grid; gap: 10px; }
  .flight-item { display: flex; justify-content: space-between; align-items: center;
    border: 1px solid var(--border); border-radius: 12px; padding: 10px 12px;
  }
  .license-box { border: 1px solid var(--border); border-radius: 16px; padding: 12px; background: #f8fafc; }
  .license-card { display: grid; grid-template-columns: auto 1fr auto; gap: 12px; align-items: center; }
  .license-img { width: 100px; border: 1px solid #d1d5db; border-radius: 8px; }
  .qr-box { display: grid; justify-items: center; gap: 4px; }
  .muted { color: var(--muted); }
  .valid { color: #16a34a; }
  .invalid { color: #dc2626; }
</style>
</head>
<body>

<!-- Existing views unchanged until dashboard -->
<div id="loginView" class="centered">
  <div class="card">
    <h2>Login</h2>
    <p class="sub">Sign in to your Flight Tracker</p>
    <label>Username</label>
    <input id="username" autocomplete="username" />
    <label style="margin-top:10px;">Password</label>
    <input id="password" type="password" autocomplete="current-password" />
    <button id="loginBtn" class="btn btn-primary" style="margin-top:14px;">Log in</button>
    <div class="error" id="loginError"></div>
  </div>
</div>

<div id="dashboardView" class="hidden">
  <header>
    <div class="header-stats">
      <span class="count-badge" id="flightCount">0 Flights</span>
      <span class="count-badge" id="pointsCount">0 Points</span>
    </div>
    <div class="row">
      <button id="openScannerBtn" class="btn btn-outline w-auto">Scan QR</button>
      <button id="logoutBtn" class="btn btn-gray w-auto">Logout</button>
    </div>
  </header>
  <main>
    <div class="card-section">
      <h3 class="section-title">License</h3>
      <div id="licenseInfo" class="license-box">No license</div>
      <div class="row" style="margin-top:10px;">
        <button id="addLicenseBtn" class="btn btn-primary">Add License</button>
        <button id="fireMyselfBtn" class="btn btn-outline">Fire Myself</button>
      </div>
    </div>

    <!-- New Routes Section -->
    <div class="card-section">
      <h3 class="section-title">Routes</h3>
      <div id="routesList" class="list"></div>
      <div class="row" style="margin-top:10px;">
        <button id="addRouteBtn" class="btn btn-blue">Add Route</button>
      </div>
    </div>

    <!-- New Planes Section -->
    <div class="card-section">
      <h3 class="section-title">Planes</h3>
      <div class="row" id="planeButtons"></div>
      <div id="planesList" class="list" style="margin-top:10px;"></div>
      <div class="row" style="margin-top:10px;">
        <button id="addPlaneBtn" class="btn btn-blue">Add Plane</button>
        <button id="movePlaneBtn" class="btn btn-outline">Move Plane</button>
      </div>
    </div>

    <div class="card-section">
      <h3 class="section-title">Flights</h3>
      <div id="flightsList" class="list"></div>
      <div class="row" style="margin-top:10px;">
        <button id="addFlightBtn" class="btn btn-blue">Add Flight</button>
      </div>
    </div>
  </main>
</div>

<!-- Validation & Scanner unchanged -->
<div id="validateView" class="centered hidden">
  <div class="card" id="validationResult">Checking license…</div>
</div>
<div id="scannerView" class="centered hidden">
  <div class="card" style="width:100%;">
    <h3>Scan a License QR</h3>
    <p class="tip">Point your camera at the QR. We’ll open and validate it automatically.</p>
    <div id="reader"></div>
    <div class="row" style="margin-top:12px;">
      <button id="closeScannerBtn" class="btn btn-outline">Close</button>
    </div>
  </div>
</div>

<!-- License Modal unchanged -->
<div id="licenseModalBackdrop" class="modal-backdrop hidden">
  <!-- ... existing modal ... -->
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
/* Firebase init same as before */
const firebaseConfig = { /* your config here */ };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentUser = null;
const routesList = document.getElementById("routesList");
const addRouteBtn = document.getElementById("addRouteBtn");
const planesList = document.getElementById("planesList");
const addPlaneBtn = document.getElementById("addPlaneBtn");
const movePlaneBtn = document.getElementById("movePlaneBtn");
const planeButtons = document.getElementById("planeButtons");

const locations = ["PUNTA CANA","LARNACA","GRAN CANARIA","MENORECA","LONDON GATWICK","KITTILA"];

/* Generate location buttons */
locations.forEach(loc=>{
  const btn=document.createElement("button");
  btn.className="btn btn-outline w-auto";
  btn.textContent=loc;
  btn.onclick=()=>showPlanesAt(loc);
  planeButtons.appendChild(btn);
});

/* ROUTES */
async function renderRoutes() {
  const snap = await db.ref(`data/${currentUser}/routes`).get();
  const routes = snap.val() || [];
  routesList.innerHTML="";
  routes.forEach(r=>{
    const div=document.createElement("div");
    div.className="flight-item";
    div.textContent=`${r.from} → ${r.to}`;
    routesList.appendChild(div);
  });
}
addRouteBtn.onclick=async()=>{
  const code=prompt("Enter security code:");
  if(code!=="555") return alert("Wrong code");
  const from=prompt("From:");
  const to=prompt("To:");
  if(!from||!to) return;
  const ref=db.ref(`data/${currentUser}/routes`);
  const snap=await ref.get();
  const routes=snap.val()||[];
  routes.push({from,to});
  await ref.set(routes);
  renderRoutes();
};

/* PLANES */
async function showPlanesAt(location){
  const snap = await db.ref(`data/${currentUser}/planes/${location}`).get();
  const planes = snap.val() || [];
  planesList.innerHTML=`<h4>${location}</h4>`;
  planes.forEach(p=>{
    const div=document.createElement("div");
    div.className="flight-item";
    div.textContent=`${p.id} - ${p.type}`;
    planesList.appendChild(div);
  });
}
addPlaneBtn.onclick=async()=>{
  const code=prompt("Enter security code:");
  if(code!=="555") return alert("Wrong code");
  const type=prompt("Enter plane type:");
  if(!type) return;
  const loc=prompt("Enter location:");
  if(!loc||!locations.includes(loc)) return alert("Invalid location");
  const id="PLN-"+Math.random().toString(36).slice(2,6).toUpperCase();
  const ref=db.ref(`data/${currentUser}/planes/${loc}`);
  const snap=await ref.get();
  const planes=snap.val()||[];
  planes.push({id,type});
  await ref.set(planes);
  showPlanesAt(loc);
};
movePlaneBtn.onclick=async()=>{
  const code=prompt("Enter security code:");
  if(code!=="555") return alert("Wrong code");
  const from=prompt("Move from location:");
  if(!from||!locations.includes(from)) return alert("Invalid");
  const snap=await db.ref(`data/${currentUser}/planes/${from}`).get();
  const planes=snap.val()||[];
  if(!planes.length) return alert("No planes there");
  const id=prompt("Enter plane ID to move:");
  const idx=planes.findIndex(p=>p.id===id);
  if(idx===-1) return alert("Not found");
  const to=prompt("Move to location:");
  if(!to||!locations.includes(to)) return alert("Invalid");
  const plane=planes.splice(idx,1)[0];
  await db.ref(`data/${currentUser}/planes/${from}`).set(planes);
  const snap2=await db.ref(`data/${currentUser}/planes/${to}`).get();
  const destPlanes=snap2.val()||[];
  destPlanes.push(plane);
  await db.ref(`data/${currentUser}/planes/${to}`).set(destPlanes);
  showPlanesAt(to);
};

/* Ensure data root with initial route */
async function ensureDataRoot(){
  const ref=db.ref(`data/${currentUser}`);
  const snap=await ref.get();
  const data=snap.val()||{};
  if(!data.routes){
    data.routes=[{from:"PUNTA CANA",to:"MENORECA"}];
  }
  if(!data.planes){
    data.planes={};
    locations.forEach(l=>data.planes[l]=[]);
  }
  await ref.set(data);
}

/* Load all */
async function loadData(){
  renderRoutes();
}

/* Session */
const saved=localStorage.getItem("ft_user");
if(saved){
  currentUser=saved;
  ensureDataRoot().then(loadData).then(()=>document.getElementById("dashboardView").classList.remove("hidden"));
} else {
  document.getElementById("loginView").classList.remove("hidden");
}
</script>
</body>
</html>
