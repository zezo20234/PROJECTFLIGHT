<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Flight Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  * { box-sizing: border-box; }
  body {
    margin: 0; padding: 0; font-family: system-ui, Arial, sans-serif;
    background: #f8fafc; color: #0f172a;
  }
  /* Login styles */
  .centered {
    display: flex; align-items: center; justify-content: center;
    min-height: 100vh;
  }
  .card {
    background: #fff; padding: 24px; border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,.08);
    width: 100%; max-width: 380px;
  }
  input {
    width: 100%; padding: 10px; margin-top: 8px;
    border-radius: 8px; border: 1px solid #ccc; font-size: 14px;
  }
  button {
    padding: 10px 16px; border: 0; border-radius: 8px;
    background: #7c3aed; color: #fff; font-weight: bold;
    cursor: pointer; margin-top: 12px; width: 100%;
  }
  button:hover { opacity: .95; }
  .error { color: #dc2626; margin-top: 8px; font-size: 14px; }
  /* Dashboard styles */
  header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 12px 16px; background: #fff; border-bottom: 1px solid #ddd;
    position: sticky; top: 0;
  }
  .count-badge {
    background: #eef2ff; color: #3730a3; padding: 4px 10px;
    border-radius: 999px; font-weight: bold;
  }
  main { padding: 16px; display: grid; gap: 20px; }
  .card-section {
    background: #fff; border-radius: 16px; padding: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,.05);
  }
  .list { display: grid; gap: 10px; }
  .flight-item {
    border: 1px solid #ddd; border-radius: 8px; padding: 8px 10px;
    display: flex; justify-content: space-between;
  }
  .license-box {
    border: 1px solid #ddd; border-radius: 8px; padding: 10px;
    background: #f8fafc;
  }
</style>
</head>
<body>

<!-- Login UI -->
<div id="loginView" class="centered">
  <div class="card">
    <h2>Login</h2>
    <input id="username" placeholder="Username">
    <input id="password" type="password" placeholder="Password">
    <button id="loginBtn">Login</button>
    <div class="error" id="loginError"></div>
    <p style="font-size:12px; color:#666;">Demo: layan:246 • asser:456 • zezo:000</p>
  </div>
</div>

<!-- Dashboard UI -->
<div id="dashboardView" style="display:none;">
  <header>
    <div><span class="count-badge" id="flightCount">0 Flights</span></div>
    <div>
      <button id="logoutBtn" style="background:#6b7280;">Logout</button>
    </div>
  </header>
  <main>
    <div class="card-section">
      <h3>License</h3>
      <div id="licenseInfo" class="license-box">No license</div>
      <button id="addLicenseBtn" style="margin-top:8px;">Add License</button>
    </div>
    <div class="card-section">
      <h3>Flights</h3>
      <div class="list" id="flightsList"></div>
      <button id="addFlightBtn" style="margin-top:8px; background:#0ea5e9;">Add Flight</button>
    </div>
  </main>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script>
  // Config
  const firebaseConfig = {
    apiKey: "AIzaSyAjeXycCBhYoAU-0iiC4LbSTylKrrThN8Y",
    authDomain: "sharplabubu.firebaseapp.com",
    databaseURL: "https://sharplabubu-default-rtdb.firebaseio.com",
    projectId: "sharplabubu",
    storageBucket: "sharplabubu.firebasestorage.app",
    messagingSenderId: "596148393481",
    appId: "1:596148393481:web:4f822d86c44a13bd810ad8",
    measurementId: "G-4M25R3BF08"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Seed users if missing
  async function seedUsers() {
    const snap = await db.ref("users").get();
    if (!snap.exists()) {
      await db.ref("users").set({
        layan: { password: "246" },
        asser: { password: "456" },
        zezo: { password: "000" }
      });
    }
  }
  seedUsers();

  let currentUser = null;

  // UI refs
  const loginView = document.getElementById("loginView");
  const dashView = document.getElementById("dashboardView");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const loginError = document.getElementById("loginError");
  const flightCount = document.getElementById("flightCount");
  const flightsList = document.getElementById("flightsList");
  const licenseInfo = document.getElementById("licenseInfo");
  const addFlightBtn = document.getElementById("addFlightBtn");
  const addLicenseBtn = document.getElementById("addLicenseBtn");

  // Login
  loginBtn.onclick = async () => {
    const u = document.getElementById("username").value.trim();
    const p = document.getElementById("password").value.trim();
    loginError.textContent = "";
    const snap = await db.ref("users/" + u).get();
    if (!snap.exists()) {
      loginError.textContent = "User not found";
      return;
    }
    if (snap.val().password === p) {
      currentUser = u;
      localStorage.setItem("ft_user", u);
      showDashboard();
    } else {
      loginError.textContent = "Wrong password";
    }
  };

  logoutBtn.onclick = () => {
    localStorage.removeItem("ft_user");
    currentUser = null;
    dashView.style.display = "none";
    loginView.style.display = "flex";
  };

  // Show dashboard
  async function showDashboard() {
    loginView.style.display = "none";
    dashView.style.display = "block";
    loadData();
  }

  // Load flights and license
  async function loadData() {
    if (!currentUser) return;
    const dataRef = db.ref("data/" + currentUser);
    const snap = await dataRef.get();
    let data = snap.val() || {};
    // Check license expiry
    if (data.license && new Date(data.license.expiry) < new Date()) {
      await dataRef.child("license").remove();
      data.license = null;
    }
    renderLicense(data.license);
    renderFlights(data.flights || []);
  }

  function renderLicense(license) {
    if (license) {
      licenseInfo.innerHTML = `
        <div>Signature: ${license.signature}</div>
        <div>Expires: ${license.expiry}</div>
      `;
    } else {
      licenseInfo.textContent = "No license";
    }
  }

  function renderFlights(flights) {
    flightsList.innerHTML = "";
    const list = flights || [];
    list.forEach(f => {
      const div = document.createElement("div");
      div.className = "flight-item";
      div.innerHTML = `<span>${f.callSign} (${f.dep} → ${f.arr})</span>`;
      flightsList.appendChild(div);
    });
    flightCount.textContent = `${list.length} Flights`;
  }

  // Add license
  addLicenseBtn.onclick = async () => {
    const code = prompt("Enter security code:");
    if (code !== "555") return alert("Wrong code");
    const signature = prompt("Enter signature:");
    if (!signature) return;
    const weeks = prompt("Enter duration (1 or 2 weeks):");
    const w = parseInt(weeks);
    if (![1,2].includes(w)) return alert("Invalid duration");
    const expiryDate = new Date();
    expiryDate.setDate(expiryDate.getDate() + w*7);
    await db.ref("data/" + currentUser + "/license").set({
      signature, expiry: expiryDate.toISOString().split("T")[0]
    });
    loadData();
  };

  // Add flight
  addFlightBtn.onclick = async () => {
    const code = prompt("Enter security code:");
    if (code !== "555") return alert("Wrong code");
    const callSign = prompt("Enter call sign:");
    const dep = prompt("Enter departure airport:");
    const arr = prompt("Enter arrival airport:");
    if (!callSign || !dep || !arr) return;
    const flightsSnap = await db.ref("data/" + currentUser + "/flights").get();
    const flights = flightsSnap.val() || [];
    flights.push({ callSign, dep, arr });
    await db.ref("data/" + currentUser + "/flights").set(flights);
    loadData();
  };

  // Auto-login if session exists
  const saved = localStorage.getItem("ft_user");
  if (saved) {
    currentUser = saved;
    showDashboard();
  }
</script>

</body>
</html>
